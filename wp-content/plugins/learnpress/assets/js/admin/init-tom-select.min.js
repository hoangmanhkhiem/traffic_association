import{AdminUtilsFunctions,Api,Utils}from"./utils-admin.js";const handleResponse=(e,t,a,n,s={},r)=>{if(!(e&&t&&a&&n&&r))return;const l=e=>{if(!a.keyGetValue?.text||!a.keyGetValue.key_render)return;let t=a.keyGetValue.text;for(const[n,s]of Object.entries(a.keyGetValue.key_render))t=t.replace(new RegExp(`{{${s}}}`,"g"),e[s]);return t},i=t.dataset?.saved?JSON.parse(t.dataset.saved):0;let o=[];e.data[a.dataType].length>0&&(o=e.data[a.dataType].map((e=>({value:e[a.keyGetValue.value],text:l(e)}))));const c={items:i,render:{item:(e,t)=>`<li data-id="${e.value}">\n\t\t\t\t\t\t<div class="item">${e.text}</div>\n\t\t\t\t\t</li>`},onChange:e=>{e.length<1&&(t.value="")},...s,options:o};return null!=t.tomSelectInstance?(t.tomSelectInstance.addOptions(o),o):(t.tomSelectInstance=AdminUtilsFunctions.buildTomSelect(t,c,n,{},r),o)},initTomSelect=(e,t={},a={})=>{if(!e)return;const n=e.dataset?.saved?JSON.parse(e.dataset.saved):0,s=e?.dataset?.struct?JSON.parse(e.dataset.struct):"";if(!s)return;const r=(e,t)=>{const a=t.parentElement;return a.tagName.toLowerCase()===e?a:r(e,a)},l=r("form",e).querySelector('input[name="'+e.getAttribute("name")+'"]');l&&l.remove();const i=s.dataSendApi,o=s.urlApi,c={...s.setting,...t},d=(e="",t,a)=>{const s=o,r={current_ids:n,...i,...t};r.search=e;const l={headers:{"Content-Type":"application/json","X-WP-Nonce":lpDataAdmin.nonce},method:"POST",body:JSON.stringify(r)};Utils.lpFetchAPI(s,l,a)},u={success:t=>{handleResponse(t,e,s,d,c,u)}};d("",a,u)},searchUserOnListPost=()=>{if("0"===lpDataAdmin.show_search_author_field)return;const e=document.querySelector("#posts-filter");if(!e)return;let t=e.querySelector(".search-box");if(t||(e.insertAdjacentHTML("afterbegin",lpDataAdmin.show_search_author_field),t=e.querySelector(".search-box")),!t)return;(()=>{let a="";const n=lpDataAdmin.urlParams.author;n&&(a=JSON.stringify(n));const s={urlApi:Api.admin.apiSearchUsers,dataType:"users",keyGetValue:{value:"ID",text:"{{display_name}}(#{{ID}}) - {{user_email}}",key_render:{display_name:"display_name",user_email:"user_email",ID:"ID"}},setting:{placeholder:"Choose author"}},r=`<select data-struct='${JSON.stringify(s)}' style='display:none;' data-saved='${a}'\n\t\t\t\t\tid="author" name="author" class="select lp-tom-select"></select>`,l=t.querySelector('input[name="s"]');l&&l.insertAdjacentHTML("afterend",r);const i=e.querySelector('input[name="author"]');i&&i.remove()})()},defaultInitTomSelect=(e=[])=>{const t=Array.prototype.slice.call(document.querySelectorAll(".lp-tom-select"));t.length&&t.map((t=>{e.length&&e.includes(t)||initTomSelect(t)}))};export{initTomSelect,searchUserOnListPost,defaultInitTomSelect};